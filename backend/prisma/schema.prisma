// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================================================
// ENUMS
// =====================================================

enum Department {
  Withering
  Rolling
  Dryer
  Packing
  Boiler
  Office
}

enum Designation {
  Helper
  MachineOperator @map("Machine Operator")
  Supervisor
  Clerk
}

enum EmploymentType {
  Permanent
  Casual @map("Casual / Daily Paid")
  Contract
}

enum EmployeeStatus {
  Active
  Inactive
}

enum PayType {
  DailyWage   @map("Daily wage")
  MonthlySalary @map("Monthly salary")
  Hourly
}

enum Shift {
  Day
  Night
  FullDay @map("Full Day")
}

enum AttendanceStatus {
  Present
  Absent
  HalfDay @map("Half Day")
  OnLeave @map("On Leave")
}

enum TransactionType {
  Expense
  Income
}

enum ExpenseCategory {
  GreenLeafCost       @map("Green Leaf Cost")
  LaborCost           @map("Labor Cost")
  FuelPower           @map("Fuel & Power")
  PackingMaterials    @map("Packing Materials")
  FactoryOverheads    @map("Factory Overheads")
  MaintenanceRepairs  @map("Maintenance & Repairs")
  Administrative      @map("Administrative Expenses")
  TransportHandling   @map("Transport & Handling")
  Financial           @map("Financial Expenses")
}

enum IncomeCategory {
  MadeTeaSales @map("Made Tea Sales")
  OtherIncome  @map("Other Income")
}

enum PaymentType {
  Cash
  Bank
  Credit
}

enum SupplierType {
  estate
  smallholder
}

enum Session {
  AM
  PM
}

enum TeaGrade {
  OP1
  OPA
  BOP1
  PEK
  PEK1
  FBOP
  FBOPF1
  BOPA
  BOPFSP
  BOPFEXSP
  BM
  BP
  BOP1A
  BT
  DUST1
  DUST
}

enum InventoryTransactionType {
  inflow
  outflow
}

enum MadeTeaTransactionType {
  production
  dispatch
}

// =====================================================
// USER & AUTHENTICATION
// =====================================================

model User {
  id           String    @id @default(uuid())
  username     String    @unique
  email        String    @unique
  passwordHash String    @map("password_hash")
  fullName     String    @map("full_name")
  role         String    @default("user")
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  lastLogin    DateTime? @map("last_login")

  // Relations
  employeesCreated      Employee[]          @relation("EmployeeCreatedBy")
  employeesUpdated      Employee[]          @relation("EmployeeUpdatedBy")
  attendanceMarked      AttendanceRecord[]  @relation("AttendanceMarkedBy")
  attendanceEdited      AttendanceRecord[]  @relation("AttendanceEditedBy")
  transactionsCreated   Transaction[]       @relation("TransactionCreatedBy")
  transactionsEdited    Transaction[]       @relation("TransactionEditedBy")
  firewoodTransactions  FirewoodTransaction[]
  packingTransactions   PackingMaterialsTransaction[]
  greenLeafIntakes      GreenLeafIntake[]
  productionBatches     ProductionBatch[]
  madeTeaTransactions   MadeTeaTransaction[]
  productionEntries     ProductionEntry[]
  dispatchRecords       DispatchRecord[]
  activityLogs          ActivityLog[]
  settingsUpdated       SystemSetting[]

  @@map("users")
}

// =====================================================
// EMPLOYEES
// =====================================================

model Employee {
  id             String         @id // Format: EMP250001
  fullName       String         @map("full_name")
  nicNumber      String         @unique @map("nic_number")
  contactNumber  String         @map("contact_number")
  address        String?
  department     Department
  designation    Designation
  employmentType EmploymentType @map("employment_type")
  joinDate       DateTime       @map("join_date") @db.Date
  status         EmployeeStatus @default(Active)
  payType        PayType        @map("pay_type")
  rate           Decimal        @db.Decimal(10, 2)
  otRate         Decimal?       @map("ot_rate") @db.Decimal(10, 2)
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")
  createdById    String?        @map("created_by")
  updatedById    String?        @map("updated_by")

  // Relations
  createdBy   User?              @relation("EmployeeCreatedBy", fields: [createdById], references: [id])
  updatedBy   User?              @relation("EmployeeUpdatedBy", fields: [updatedById], references: [id])
  attendance  AttendanceRecord[]

  @@index([department])
  @@index([status])
  @@index([employmentType])
  @@map("employees")
}

// =====================================================
// ATTENDANCE
// =====================================================

model AttendanceRecord {
  id             String           @id @default(uuid())
  employeeId     String           @map("employee_id")
  date           DateTime         @db.Date
  shift          Shift
  status         AttendanceStatus
  otHours        Decimal          @default(0) @map("ot_hours") @db.Decimal(5, 2)
  calculatedWage Decimal          @map("calculated_wage") @db.Decimal(10, 2)
  remarks        String?
  markedById     String?          @map("marked_by")
  markedAt       DateTime         @default(now()) @map("marked_at")
  lastEditedById String?          @map("last_edited_by")
  lastEditedAt   DateTime?        @map("last_edited_at")

  // Relations
  employee     Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  markedBy     User?    @relation("AttendanceMarkedBy", fields: [markedById], references: [id])
  lastEditedBy User?    @relation("AttendanceEditedBy", fields: [lastEditedById], references: [id])

  @@unique([employeeId, date, shift])
  @@index([date])
  @@index([employeeId])
  @@index([status])
  @@map("attendance_records")
}

// =====================================================
// FINANCIAL TRANSACTIONS
// =====================================================

model Transaction {
  id             String          @id // Format: TXN000001
  date           DateTime        @db.Date
  type           TransactionType
  category       String
  description    String
  amount         Decimal         @db.Decimal(12, 2)
  paymentType    PaymentType     @map("payment_type")
  referenceNo    String?         @map("reference_no")
  remarks        String?
  createdAt      DateTime        @default(now()) @map("created_at")
  createdById    String?         @map("created_by")
  lastEditedAt   DateTime?       @map("last_edited_at")
  lastEditedById String?         @map("last_edited_by")

  // Relations
  createdBy    User? @relation("TransactionCreatedBy", fields: [createdById], references: [id])
  lastEditedBy User? @relation("TransactionEditedBy", fields: [lastEditedById], references: [id])

  @@index([date])
  @@index([type])
  @@index([category])
  @@map("transactions")
}

// =====================================================
// INVENTORY - FIREWOOD
// =====================================================

model FirewoodTransaction {
  id             String                   @id @default(uuid())
  date           DateTime                 @db.Date
  time           DateTime                 @db.Time
  type           InventoryTransactionType
  quantity       Decimal                  @db.Decimal(10, 2)
  factory        String?
  supervisor     String?
  remarks        String?
  runningBalance Decimal                  @map("running_balance") @db.Decimal(10, 2)
  createdAt      DateTime                 @default(now()) @map("created_at")
  createdById    String?                  @map("created_by")

  // Relations
  createdBy User? @relation(fields: [createdById], references: [id])

  @@index([date])
  @@index([type])
  @@map("firewood_transactions")
}

// =====================================================
// INVENTORY - PACKING MATERIALS
// =====================================================

model PackingMaterialsTransaction {
  id             String                   @id @default(uuid())
  date           DateTime                 @db.Date
  time           DateTime                 @db.Time
  type           InventoryTransactionType
  quantity       Decimal                  @db.Decimal(10, 2)
  materialType   String?                  @map("material_type")
  factory        String?
  supervisor     String?
  remarks        String?
  runningBalance Decimal                  @map("running_balance") @db.Decimal(10, 2)
  createdAt      DateTime                 @default(now()) @map("created_at")
  createdById    String?                  @map("created_by")

  // Relations
  createdBy User? @relation(fields: [createdById], references: [id])

  @@index([date])
  @@index([type])
  @@map("packing_materials_transactions")
}

// =====================================================
// INVENTORY - GREEN LEAF
// =====================================================

model GreenLeafIntake {
  id            String       @id @default(uuid())
  date          DateTime     @db.Date
  time          DateTime     @db.Time
  supplier      String
  supplierType  SupplierType @map("supplier_type")
  vehicleNumber String       @map("vehicle_number")
  grossWeight   Decimal      @map("gross_weight") @db.Decimal(10, 2)
  tareWeight    Decimal      @map("tare_weight") @db.Decimal(10, 2)
  netWeight     Decimal      @map("net_weight") @db.Decimal(10, 2)
  quality       String?
  session       Session
  remarks       String?
  createdAt     DateTime     @default(now()) @map("created_at")
  createdById   String?      @map("created_by")

  // Relations
  createdBy User? @relation(fields: [createdById], references: [id])

  @@index([date])
  @@index([supplier])
  @@index([session])
  @@map("green_leaf_intake")
}

// =====================================================
// PRODUCTION BATCHES
// =====================================================

model ProductionBatch {
  id              String   @id @default(uuid())
  batchNumber     String   @unique @map("batch_number")
  date            DateTime @db.Date
  greenLeafUsed   Decimal  @map("green_leaf_used") @db.Decimal(10, 2)
  madeTeaProduced Decimal  @map("made_tea_produced") @db.Decimal(10, 2)
  yieldPercentage Decimal  @map("yield_percentage") @db.Decimal(5, 2)
  createdAt       DateTime @default(now()) @map("created_at")
  createdById     String?  @map("created_by")

  // Relations
  createdBy User? @relation(fields: [createdById], references: [id])

  @@index([date])
  @@index([batchNumber])
  @@map("production_batches")
}

// =====================================================
// MADE TEA STOCK
// =====================================================

model MadeTeaStock {
  id          String   @id @default(uuid())
  grade       TeaGrade @unique
  quantity    Decimal  @default(0) @db.Decimal(10, 2)
  lastUpdated DateTime @default(now()) @updatedAt @map("last_updated")

  @@map("made_tea_stock")
}

// =====================================================
// MADE TEA TRANSACTIONS
// =====================================================

model MadeTeaTransaction {
  id          String                   @id @default(uuid())
  date        DateTime                 @db.Date
  time        DateTime                 @db.Time
  reference   String
  type        MadeTeaTransactionType
  grade       TeaGrade
  inflow      Decimal                  @default(0) @db.Decimal(10, 2)
  outflow     Decimal                  @default(0) @db.Decimal(10, 2)
  balance     Decimal                  @db.Decimal(10, 2)
  details     String?
  createdAt   DateTime                 @default(now()) @map("created_at")
  createdById String?                  @map("created_by")

  // Relations
  createdBy User? @relation(fields: [createdById], references: [id])

  @@index([date])
  @@index([type])
  @@index([grade])
  @@map("made_tea_transactions")
}

// =====================================================
// PRODUCTION ENTRIES
// =====================================================

model ProductionEntry {
  id           String   @id @default(uuid())
  date         DateTime @db.Date
  batchNumber  String   @map("batch_number")
  grade        TeaGrade
  quantity     Decimal  @db.Decimal(10, 2)
  qualityNotes String?  @map("quality_notes")
  createdAt    DateTime @default(now()) @map("created_at")
  createdById  String?  @map("created_by")

  // Relations
  createdBy User? @relation(fields: [createdById], references: [id])

  @@index([date])
  @@index([grade])
  @@map("production_entries")
}

// =====================================================
// DISPATCH RECORDS
// =====================================================

model DispatchRecord {
  id             String   @id @default(uuid())
  date           DateTime @db.Date
  dispatchNumber String   @unique @map("dispatch_number")
  grade          TeaGrade
  quantity       Decimal  @db.Decimal(10, 2)
  destination    String
  buyer          String?
  vehicleNumber  String?  @map("vehicle_number")
  invoiceNumber  String?  @map("invoice_number")
  remarks        String?
  createdAt      DateTime @default(now()) @map("created_at")
  createdById    String?  @map("created_by")

  // Relations
  createdBy User? @relation(fields: [createdById], references: [id])

  @@index([date])
  @@index([grade])
  @@index([destination])
  @@map("dispatch_records")
}

// =====================================================
// ACTIVITY LOG
// =====================================================

model ActivityLog {
  id           String   @id @default(uuid())
  activityType String   @map("activity_type")
  description  String
  userId       String?  @map("user_id")
  entityType   String?  @map("entity_type")
  entityId     String?  @map("entity_id")
  metadata     Json?
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id])

  @@index([createdAt(sort: Desc)])
  @@index([userId])
  @@index([activityType])
  @@map("activity_log")
}

// =====================================================
// SYSTEM SETTINGS
// =====================================================

model SystemSetting {
  key         String    @id
  value       String
  description String?
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at")
  updatedById String?   @map("updated_by")

  // Relations
  updatedBy User? @relation(fields: [updatedById], references: [id])

  @@map("system_settings")
}
